<%@games.each do |game|%>
  <div>
    <div onclick="game_info(<%=game.id%>)">
      <div>
        <img src="<%=game.image.url(:original)%>" alt="" />
      </div>
      <div>
        <%=game.name%>
      </div>
      <div>
        <%=game.genre_names%>
      </div>
    </div>
    <div>
      <%if current_user.nil?%>
        <input type="number" class="rating" value="0" game_id="<%=game.id%>" />
      <%else%>
        <input type="number" class="rating" game_id="<%=game.id%>" value="<%= game.rate current_user.id %>" />
      <%end%>
      <input type="button" onclick="rating(<%=game.id%>)" value="평점 매기기" />
    </div>
  </div>
  <hr />
<%end%>

<div class="modal fade" id="info_modal" game_id="">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <div class="name">
          <span class="info"></span>
        </div>
      </div>
      <div class="modal-body">
        <div class="image">
          이미지
          <img class="info" src="" alt="" />
        </div>
        <div class="genre">
          장르
          <span class="info"></span>
        </div>
        <div class="platform">
          플랫폼
          <span class="info"></span>
        </div>
        <div class="maker">
          제작사
          <span class="info"></span>
        </div>
        <div class="distribute">
          유통사
          <span class="info"></span>
        </div>
        <div class="date">
          날짜
          <span class="info"></span>
        </div>
        <div class="user_class">
          사용자 등급
          <span class="info"></span>
        </div>
        <div class="movie">
          영상
          <span class="info"></span>
        </div>
        <div class="content">
          소개
          <span class="info"></span>
        </div>
      </div>
      <div class="modal-footer">
        <div class="comment">
          <div class="show-comment">
          </div>
          <div class="send-comment">
            <input type="text" class="message" value="" />
            <input type="button" class="send-comment" onclick="make_comment()" value="" />
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<script type="text/javascript" charset="utf-8">
  var current_game_id = 0

  function game_info(game_id){
    $.ajax({
      url: "/api/game_info/",
      dataType: "JSON",
      type: "POST",
      data: {
        game_id: game_id
      },
      success: function(data) {
        var game = data[0]
        var info = data[1]
        var comment = data[2]
        console.log(data)
        current_game_id = game.id
        $("#info_modal .name .info").text(game.name)
        $("#info_modal .image .info").attr("src", info.image_url)
        $("#info_modal .distribute .info").text(info.distribute)
        $("#info_modal .platform .info").text(info.platform_name)
        $("#info_modal .genre .info").text(info.genre_name)
        $("#info_modal .date .info").text(info.date)
        $("#info_modal .user_class .info").text(info.user_class)
        $("#info_modal .maker .info").text(info.maker)
        $("#info_modal .movie .info").html(info.movie)
        $("#info_modal .content .info").text(info.content)
        $("#info_modal .show-comment").html("")
        $("#info_modal .send-comment").show()
        for(var i=0;i<comment.length;i++){
          add_comment(comment[i].email, comment[i].content, comment[i].score)
          if(comment[i].id == <%=current_user.id%>){
            $("#info_modal .send-comment").hide()
          }

        }
        $("#info_modal").modal("show")
      }
    })
  }
  function make_comment() {
    var message = $(".send-comment .message").val()
    $.ajax({
      url: "/api/make_comment/",
      dataType:"JSON",
      type: "POST",
      data: {
        game_id:current_game_id,
        message: message
      },
      success: function(data) {
        var score = data[0]
        add_comment("<%=current_user.email%>", message, score)
        $("#info_modal .send-comment").hide()
      }
    })
  }
  function add_comment(email, message, score) {
    $(".show-comment").prepend("<div>" + email + "(" + score + ") : " + message + "</div>")
  }
  function rating(game_id) {
    var score = $(".rating[game_id="+game_id+"]").val()
    $.ajax({
      url: "/api/set_rating/",
      dataType:"JSON",
      type: "POST",
      data: {
        game_id:game_id,
        score:score
      },
      success: function(data) {
      }
    })
  }
</script>
